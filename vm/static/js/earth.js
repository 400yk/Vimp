var ge;
var ge_obj;

google.load("earth", "1");

function colorPolygon(object, precinct_name, yes_no) {
    var type = object.getType();
    if (type == 'KmlDocument' || type == 'KmlFolder') {
        var features = object.getFeatures();
        if (features.hasChildNodes()) {
            var children = features.getChildNodes();
            for (i = 0; i < children.getLength(); i++) {
                colorPolygon(children.item(i), precinct_name, yes_no);
            }
        }

    } else if (type == 'KmlPlacemark') {
        if (object.getName() === precinct_name) {
            // If polygonPlacemark doesn't already have a Style associated
            //             // with it, we create it now.
            //
            //                         if (!object.getStyleSelector()) {
            //                                       object.setStyleSelector(ge.createStyle(''));
            //                                                   }
            //                                                               
            //                                                                           
            //                                                                                       // Color can also be specified by individual color components.
            //                                                                                                   var polyColor = 
            //                                                                                                                   object.getStyleSelector().getPolyStyle().getColor();            
            //                                                                                                                               if (yes_no == 0) {
            //                                                                                                                                             polyColor.setA(150);
            //                                                                                                                                                           polyColor.setB(255);
            //                                                                                                                                                                         polyColor.setG(0);
            //                                                                                                                                                                                       polyColor.setR(255);
            //                                                                                                                                                                                                   }
            //                                                                                                                                                                                                               if (yes_no == 1) { // more yes votes than no votes, set color to red
            //                                                                                                                                                                                                                             polyColor.setA(150);
            //                                                                                                                                                                                                                                           polyColor.setB(0);
            //                                                                                                                                                                                                                                                         polyColor.setG(0);
            //                                                                                                                                                                                                                                                                       polyColor.setR(255);       
            //                                                                                                                                                                                                                                                                                   }
            //                                                                                                                                                                                                                                                                                               if (yes_no == -1) { // less yes votes than no votes, set color to blue
            //                                                                                                                                                                                                                                                                                                             polyColor.setA(150);
            //                                                                                                                                                                                                                                                                                                                           polyColor.setB(255);
            //                                                                                                                                                                                                                                                                                                                                         polyColor.setG(0);
            //                                                                                                                                                                                                                                                                                                                                                       polyColor.setR(0);                 
            //                                                                                                                                                                                                                                                                                                                                                                   }
            //                                                                                                                                                                                                                                                                                                                                                                             }   
            //                                                                                                                                                                                                                                                                                                                                                                                     } 
            //                                                                                                                                                                                                                                                                                                                                                                                           }
            //                                                                                                                                                                                                                                                                                                                                                                                               
            //                                                                                                                                                                                                                                                                                                                                                                                                     function finished(object) {
            //                                                                                                                                                                                                                                                                                                                                                                                                             if (!object) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                       // wrap alerts in API callbacks and event handlers
            //                                                                                                                                                                                                                                                                                                                                                                                                                                 // in a setTimeout to prevent deadlock in some browsers
            //                                                                                                                                                                                                                                                                                                                                                                                                                                           setTimeout(function() {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                       alert('Bad or null KML.');
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }, 0);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ge_obj = object;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               function init() {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     google.earth.createInstance('map3d', initCallback, failureCallback);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function initCallback(instance) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ge = instance;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ge.getWindow().setVisibility(true);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // add a navigation control
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // add some layers
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS, true);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ge.getLayerRoot().enableLayerById(ge.LAYER_ROADS, true);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // in this sample we will attempt
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // to fetch a  KML file and show it
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // fetch the KML
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     var kmlurl = 'http://localhost:1337/kern.kml';
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 google.earth.fetchKml(ge, kmlurl, finished);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           document.getElementById('installed-plugin-version').innerHTML =
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ge.getPluginVersion().toString();
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if (window.File && window.FileReader && window.FileList && window.Blob) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             var fileInput = document.getElementById('fileInput');
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   var fileDisplayArea = document.getElementById('fileDisplayArea');
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               fileInput.addEventListener('change', function(e) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       var file = fileInput.files[0];
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               var textType = /text.*/;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       var data;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if (file.type.match(textType)) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 var reader = new FileReader();
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     reader.onload = function(e) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 data = reader.result;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             fileDisplayArea.innerText = data;        
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         data = data.split("\n");
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (var i = 1; i < data.length; i++) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                var data_line = data[i].split(",");
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            var precinct = data_line[0];
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        var vote_yes = data_line[1];
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    var vote_no = data_line[4];  
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (vote_yes && vote_no) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                var number = vote_yes - vote_no;
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (number < 0) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            colorPolygon(ge_obj, precinct, -1);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (number > 0) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          colorPolygon(ge_obj, precinct, 1);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (number == 0) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          colorPolygon(ge_obj, precinct, 0);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }  
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }             
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } // end of reader onload function
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                reader.readAsText(file);   
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ge.getFeatures().appendChild(ge_obj);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        var la = ge.createLookAt('');
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    la.set(35.321394, -119.016564, 25, ge.ALTITUDE_RELATIVE_TO_GROUND,
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0, 0, 40000);
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ge.getView().setAbstractView(la);      
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           } else {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     fileDisplayArea.innerText = "File not supported!";
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }); // End of addEventListener
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       } else {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             alert('The File APIs are not fully supported by your browser.');
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }     
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } // End of function initCallBack
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   function failureCallback(errorCode) {
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
